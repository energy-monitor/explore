---
title: "Gas Savings estimation explanation"
output: md_document
date: '2022-11-20'
---

```{r setupBase, include=FALSE}
# - INIT -----------------------------------------------------------------------
rm(list=ls())
source("calc/prediction-gas-consumption/_shared.r")
loadPackages(tidyverse, knitr)

# - CONF -----------------------------------------------------------------------
# ggplot theme
source("analysis/theme.r")
```

```{r setupData, include=FALSE}
d.base = loadBase(FALSE)
min(d.base$date)

# start data with first complete year
d.base = d.base[year >= min(d.base[day == 1]$year)]
# d.base = d.base[year >= 2017]

# remove most recent
# d.base = d.base[date <= "2022-11-10"]
```

# Temperaturkorrigierte Einsparungen des Gasverbrauchs

## Motivation

In Medien, aber auch in offiziellen Quellen, bspw. dem Energiemonitor des BMK [energie.gv.at](https://energie.gv.at) werden oft Zahlen zur Gasverbraucheinsparung genannt, die meist auf einfachen Vegleichen zu Vorjahreswerten beruhen. Bei diesen Einschätzungen wird aber der wesentliche Treiber des Gaskonsums - die Aussentemperatur - vernachlässigt. Dies führt zu falschen Einschätzungen der Einsparungen, da das bisherige Jahr 2022 durchwegs andere Temperaturverläufe[↗](/single/others~temperature) als die Vorjahre aufweist. Wir wollen hier mit dieser Analyse einen Versuch starten, Gaskonsumeinsparungen korrigiert um Temperatureffekte einzuschätzen. Für den Konsum in Deutschland wurde dies bswp. in ... gemacht.


## Verwendete Daten

Als Datengrundlage verwenden wir öffentlich verfügbare Zeitreihen, die hier auf dieser Website auch als Indikatoren geführt werden (Download und Aufbereitsungscripts sind [hier](https://github.com/energy-monitor/explore) auffindbar). 

Die zwei maßgeblichen verwendeten Zeitreihen sind:

- Gaskonsum[↗](/single/gas~consumption-aggm): [AGGM - Austrian Gas Grid Managment AG](https://www.aggm.at/)
- Temperatur[↗](/single/others~temperature): [ERA5](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-single-levels?tab=overview)


## Analyse

### Daten

Der Verlauf des täglichen Gaskonsums[↗](/single/gas~consumption-aggm) lässt fast durchwegs bträchtliche Einsparungen seit Mitte Juli vermuten.


Die Temperatur hat erwartungsgemäß einen grossen Einfluss auf den Gaskonsum:

```{r consumTemp}
d.loess = d.base[, .(
    date, temp,
    value = value * 1000
)]

m.loess = loess(value ~ temp, d.loess)

order.loess = order(d.loess$temp)

d.lines = data.table(
    temp = d.loess$temp[order.loess],
    value = m.loess$fitted[order.loess]
)

ggplot(d.loess, aes(x = temp, y = value)) +
    geom_point(size = 0.4, alpha = 0.3) +
    geom_line(data = d.lines, size = 1, alpha = 1, color = COLORS[1]) +
    xlab(NULL) + ylab(NULL) + xlab("Temperatur in °C") + ylab("") +
    # theme(legend.position="top") 
    labs(title = "Gaskonsum vs Temperatur", subtitle = "in GWh, LOESS Linie")

temp.threshold = 14
```

Unter einem Schwellwert von knapp 15 Grad Celsius wirkt der Zusammenhang sehr linear, darüber halwegs konstant. Deshalb wird im folgenden Model nicht auf die Temperatur direkt sondern die Differenz zwischen 15 Grad und der Temperatur für Temperaturen unter 15 Grad (anderfalls 0) geschätzt.  


### Model

```{r setupModel, include=FALSE}
# - MODEL ----------------------------------------------------------------------

# AUGMENT
d.comb = copy(d.base)
d.comb[, `:=`(
    temp.below.threshold = ifelse(temp < temp.threshold, temp.threshold - temp, 0),
    temp.above.threshold = ifelse(temp > temp.threshold, temp - temp.threshold, 0)
)]

d.comb[, `:=`(
    week = str_pad(week, 2, pad = "0"),
    temp.below.threshold.squared = temp.below.threshold^2,
    temp.below.threshold.lag = shift(temp.below.threshold, 1),
    year_character = as.character(year)
)]

estimate = function(model, d, train.years = c(2000:2021)) {
    d.train = d[year %in% train.years]
    d.ret = copy(d)

    m.linear = lm(model, data = d.train)
    print(summary(m.linear))

    prediction.prediction = predict(m.linear, d.ret, interval = "prediction", level = 0.95) %>%
        as.data.table()

    prediction.confidence = predict(m.linear, d.ret, interval = "confidence", level = 0.95) %>%
        as.data.table()

    d.ret[, `:=`(
        prediction = prediction.prediction$fit,
        lower.pred = prediction.prediction$lwr,
        upper.pred = prediction.prediction$upr,
        lower.conf = prediction.confidence$lwr,
        upper.conf = prediction.confidence$upr
    )]

    d.ret[, `:=` (
        difference = (value - prediction) / prediction,
        diff.pred.lower = (value - lower.pred) / lower.pred,
        diff.pred.upper = (value - upper.pred) / upper.pred,
        diff.conf.lower = (value - lower.conf) / lower.conf,
        diff.conf.upper = (value - upper.conf) / upper.conf
    )]

    d.ret[, `:=`(
        difference.mean = rollmean(difference, 14, fill = NA)
    )]

    d.plot = d.ret[, .(date, value, prediction, difference, diff.conf.lower, diff.conf.upper, diff.pred.lower, diff.pred.upper)]
    d.plot = melt(d.plot, id.vars = "date")
    d.plot[, rollmean := rollmean(value, 14, fill = NA, align = "right"), by=variable]

    list(
        m = m.linear,
        d.pred = d.ret,
        d.plot = d.plot
    )
}

model.base = value ~
    t + t.squared + # week + 
    temp.below.threshold + temp.below.threshold.lag + temp.below.threshold.squared + 
    wday + is.holiday + as.factor(vacation.name) + is.lockdown + is.hard.lockdown

l.model.base = estimate(model.base, d.comb)
```

Ein einfaches lineares Model (OLS) wird verwendet um einerseits den Einfluss der Temperatur zu messen bzw. eine Prognose der Einsparungen zu errechen. Ein Regressionsmodel wird für den Zeitraum vor der Energiekrise geschätzt und deren Prognosen mit den tatsächlichen Gaskonsum im Jahr 2022 verglichen.

Da wir tägliche Daten verwenden wurden auch Tagesspezifika in die Regression eingefügt die auch Auswirkungen auf den Gaskonsum haben (bspw. Wochentag, Feiertag, Covid19-Lockdown, ...).

Alle Daten sind täglich seit 2015 verfügbar.

Das spezifizierte zu schätzende Model:

```{=markdown}
$$\begin{aligned} Konsum_d = \alpha + &\beta_{\bullet} t + \beta_{\bullet} t^2 + \\ &\beta_{\bullet} {Temp}_d + \beta_{\bullet} {Temp}_{d-1} + \beta_{\bullet} {Temp}_d^2 + \\ &\beta_{\bullet} Feiertag_d + \beta_{\bullet} Lockdown^{hard}_d + \beta_{\bullet} Lockdown^{soft}_d + \\ &\sum_i{\beta_{\bullet} Wochentag_{id}} + \sum_i{\beta_{\bullet} Ferientyp_{id}} \end{aligned}$$
```

Wobei es sich bei $t$ un einen täglicher Trend handelt und Temp die vorhin beschriebene modifizierte Tagestemperatur darstellt.


### Ergebnisse

Die Regressionsergebnisse folgende:

```{r regressionResultBase}
c.nice.names = c(
    `(Intercept)` = "(Intercept)", 
    t = "t", 
    t.squared = "t²", 
    temp.below.threshold = "Temp", 
    temp.below.threshold.lag = "Temp Lag", 
    temp.below.threshold.squared = "Temp²", 
    wdayTue = "Dummy Dienstag", 
    wdayWed = "Dummy Mittwoch", 
    wdayThu = "Dummy Donnerstag", 
    wdayFri = "Dummy Freitag", 
    wdaySat = "Dummy Samstag", 
    wdaySun = "Dummy Sonntag", 
    is.holidayTRUE = "Dummy Feiertag", 
    `as.factor(vacation.name)august` = "Dummy Sommerferien (August)", 
    `as.factor(vacation.name)christmasNewYear` = "Dummy Weihnachtsferien (1. Woche)", 
    `as.factor(vacation.name)eastern` = "Dummy Osterferien", 
    `as.factor(vacation.name)holy` = "Dummy Karwoche", 
    `as.factor(vacation.name)july` = "Dummy Sommerferien (Juli)", 
    `as.factor(vacation.name)newYearEpiphany` = "Dummy Weihnachtsferien (2. Woche)", 
    is.lockdownTRUE = "Lockdown Soft", 
    is.hard.lockdownTRUE = "Lockdown Hard",
    gas.power = "Gasverbrauch zum Stromerzeugung"
)

getSummaryTable = function(m) {
    d = data.table(coef(summary(m)), keep.rownames = 'term')
    d[, Variable := c.nice.names[term]]
    d[is.na(Variable), Variable := term]
    d$`Pr(>|t|)` = NULL
    d$term = NULL
    setcolorder(d, "Variable")
    d
}
kable(getSummaryTable(l.model.base$m), align = "r")
```

Mit diesem Model wird nun der Gaskonsum für die einzelnen Tage im Jahr 2022 geschätzt. Der Unterschied dieser Werte kann als Konsumänderung unabhängig der inkludierten erkläarenden Variablen interpretiert werden.

```{r modelResultLevelsBase}
d.plot = rbind(
    l.model.base$d.plot[variable %in% c('value', 'prediction')][date >= "2022-03-01"],
    l.model.base$d.plot[variable %in% c('value')][date >= "2021-03-01" & date <= "2021-11-10"][, .(
        date = as.Date(paste("2022", month(date), day(date), sep="-")),
        variable = "value21", value, rollmean
    )]
)

d.plot %>%
    ggplot(aes(x = date, y = rollmean, color = variable)) +
        geom_line(size = 1) +
        scale_color_manual(values = COLORS, name = NULL, labels = c(
            value = "Beobachtung", prediction = "Schätzung", value21 = "Vorjahr")
        ) +
        # scale_y_continuous(labels = scales::comma())
        scale_x_date(date_labels = "%b", date_breaks = "1 month") +
        xlab(NULL) + ylab(NULL) +
        labs(
            title = "Täglicher Gasverbrauch", 
            subtitle = "in TWh, 14-tägiges Mittel"
        )
```

Die relativen Abweichungen zeigen nun die Einsparungen:

```{r modelResultDiffBase}
dcast(l.model.base$d.plot[date >= "2022-03-01"], date ~ variable, value.var = "rollmean") %>%
    ggplot(aes(x = date, y = difference * 100)) +
        geom_line(size = 1) +
        geom_abline(slope = 0, intercept = 0, size = 0.5, linetype = 2) +
        # geom_ribbon(aes(ymin = diff.pred.lower, ymax = diff.pred.upper), alpha=0.3) +
        geom_ribbon(aes(ymin = diff.conf.lower * 100, ymax = diff.conf.upper * 100), alpha=0.3) +
        xlab(NULL) + ylab(NULL) +
        scale_x_date(date_labels = "%b", date_breaks ="1 month") +
        scale_y_continuous(n.breaks = 10) +
        labs(
            title = "Veränderung Gasverbrauch", 
            subtitle = "Relative Differenz zwischen Schätzung und Beobachtung, in %"
        )
```

Hier sieht man deutlich, dass im November weniger bis gar nichts eingespart wurde. Die Gaspreise[↗](/single/gas~price) entspannten sich seit Anfang September, dies hat sich wohl auf die Einsparungen negative ausgewirkt.

#### Variante mit Berücksichtigung des Gasvebrauchs zur Stromproduktion

TODO MOTIVATION

```{r setupModelPower, include=FALSE}
model.power = value ~
    t + t.squared + gas.power + # week + 
    temp.below.threshold + temp.below.threshold.lag + temp.below.threshold.squared + 
    wday + is.holiday + as.factor(vacation.name) + is.lockdown + is.hard.lockdown

l.model.power = estimate(model.power, d.comb)
```

```{r regressionResultPower, include=FALSE}
kable(getSummaryTable(l.model.power$m))
```


```{r modelResultDiffPower}
dcast(l.model.power$d.plot[date >= "2022-03-01"], date ~ variable, value.var = "rollmean") %>%
    ggplot(aes(x = date, y = difference * 100)) +
        geom_line(size = 1) +
        geom_abline(slope = 0, intercept = 0, size = 0.5, linetype = 2) +
        # geom_ribbon(aes(ymin = diff.pred.lower, ymax = diff.pred.upper), alpha=0.3) +
        geom_ribbon(aes(ymin = diff.conf.lower * 100, ymax = diff.conf.upper * 100), alpha=0.3) +
        xlab(NULL) + ylab(NULL) +
        scale_x_date(date_labels = "%b", date_breaks ="1 month") +
        scale_y_continuous(n.breaks = 10) +
        labs(
            title = "Veränderung Gasverbrauch - Variante 2", 
            subtitle = "Relative Differenz zwischen Schätzung und Beobachtung, in %"
        )
```


```{r regressionResultComparison, include=FALSE}
kable(getSummaryTable(l.model.power$m))
```

