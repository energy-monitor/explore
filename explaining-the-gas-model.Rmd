---
title: "Explanation estimate"
output: md_document
date: '2022-11-17'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.height=3, dpi=300)

source("calc/prediction-gas-consumption/_shared.r")
source("export/web-monitor/_shared.r")
loadPackages(tidyverse)

theme_set(theme_bw(base_size = 12, base_family="Century Gothic"))
theme_update(
    panel.background = element_rect(fill = "transparent", colour = NA),
    plot.background = element_rect(fill = "transparent", colour = NA),
    strip.background = element_rect(fill = "transparent", colour = NA)
)

knitr::opts_chunk$set(dev.args=list(bg="transparent"))


# - CONF -----------------------------------------------------------------------
update.data = TRUE

COLORS3 = c("#c72321", "#0d8085", "#efc220")


# - LOAD -----------------------------------------------------------------------
d.base = loadBase(update.data)

max.day = d.base %>% 
    filter(year == 2022) %>% 
    summarize(max.day = max(day))

mean.2019.2021.gas = d.base %>% 
    filter(year > 2018 & year < 2022) %>% 
    filter(day <= max.day$max.day) %>% 
    group_by(year) %>% 
    summarize(sum.val = sum(value)) %>% 
    summarize(sum.val.mean = mean(sum.val))

mean.2019.2021.hdd = d.base %>% 
    filter(year > 2018 & year < 2022) %>% 
    filter(day <= max.day$max.day) %>% 
    group_by(year) %>% 
    summarize(sum.val = sum(hdd)) %>% 
    summarize(sum.val.mean = mean(sum.val))

relative.savings = d.base %>% 
    filter(year > 2018) %>% 
    group_by(year) %>% 
    filter(day <= max.day$max.day) %>% 
    summarize(rel.save = 100 * (sum(value)-mean.2019.2021.gas$sum.val.mean)/mean.2019.2021.gas$sum.val.mean)

relative.hdd = d.base %>% 
    filter(year > 2018) %>% 
    group_by(year) %>% 
    filter(day <= max.day$max.day) %>% 
    summarize(rel.hdd = 100 * (sum(hdd)-mean.2019.2021.hdd$sum.val.mean)/mean.2019.2021.hdd$sum.val.mean)

savings.2022 = relative.savings %>% 
    filter(year == 2022) %>% 
    dplyr::select(rel.save)
```

## Wie steht es um den Gasverbrauch in Österreich?

Seit Jahresbeginn liegt der Verbrauch in Summe um `r round(savings.2022)` % unter dem Schnitt 2016-2021. Der Gasverbrauch liegt damit sogar niedriger als im Lockdown Jahr 2020. 

```{r figure1}
relative.savings %>%
    ggplot(aes(x = year, y = rel.save)) +
    geom_bar(stat = "identity") +
    xlab("Jahr") +
    ylab("Unterschied im Gasverbrauch im Vergleich \nzum Durchschnitt 2016-2021 \n in %")
```

Es gibt aber einen Zusammenhang mit der Außentemperatur: kalte Temperaturen erhöhen den Verbrauch. In einem warmen Jahr wird weniger verbraucht. Die Temperaturabhängigkeit wird dabei oft in Heizgradtagen gemessen - das ist grob gesprochen die Summe an Temperaturen für Tage, an denen geheizt werden muss. Diese war in 2022 bisher besonders niedrig.

```{r figure2}
relative.hdd %>%
    ggplot(aes(x = year, y = rel.hdd)) +
    geom_bar(stat = "identity") +
    xlab("Jahr") +
    ylab("Unterschied in Heizgradtagen im Vergleich \nzum Durchschnitt 2019-2021 \n in %") 

```

Den Zusammenhang zwischen Temperatur und Gasverbrauch sieht man sehr schön in einem Scatterplot von Temperatur gegen Gasverbrauch. Wenn die Temperatur unter 15°C fällt, wird begonnen, zu heizen - und das wirkt auf den Gasverbrauch.

```{r figure3, fig.height=5}
d.base %>%
    filter(year > 2018) %>% 
    filter(day < max.day$max.day) %>% 
    mutate(temp.lower.15 = ifelse(temp < 15, "<15°C", ">15°C")) %>% 
    ggplot(aes(x = temp, y = value)) +
        geom_point(aes(col = temp.lower.15), alpha = 0.2) +
        geom_smooth(method = "lm", aes(col = temp.lower.15)) +
        xlab("Temperatur") +
        # ylab("Täglicher Gasverbrauch \n(TWh)") +
        xlab(NULL) + ylab(NULL) +
        labs(title = "Täglicher Gasverbrauch", subtitle = "nach Jahren, in TWh") +
        scale_color_manual(values = COLORS3, name = "Temperatur") +
        facet_wrap(.~year) 

```

Diese Information kann man nutzen, um zu schätzen, wie hoch der Verbrauch in Österreich in einem "normalen" Jahr gewesen wäre. Man schätzt dazu den Einfluss von Temperatur, Feier-, und Wochentagen und Ferien auf den Verbrauch für eine Vergleichsperiode (wir verwenden 2016-2021). Damit simulieren wir in Folge wie hoch der Verbrauch in Österreich unter 2016-2021 Bedingungen mit dem Klima von 2022 gewesen wäre (Simulation) und vergleichen mit der Beobachtung. Um Schwankungen zu verringern, mitteln wir die beiden Zeitreihen über ein 14-Tage Zeitfenster. Während zwischen Mai und Mitte Oktober die Beobachtung immer unter der Simulation ist, ist sie ab Mitte Oktober, Anfang November fast gleich. Das würde darauf hindeuten, dass der niedrige Gasverbrauch im Oktober vor allem witterunsbedingt zu Stande gekommen ist. 

```{r model}


# - CONF -----------------------------------------------------------------------
update.data = TRUE


# - LOAD -----------------------------------------------------------------------
d.base = loadBase(update.data)
d.economic.activity = loadFromStorage(id = "economic-activity")[, .(
    year, month, economic.activity = value
)]


d.comb = merge(d.base, d.economic.activity, by = c("year", "month"), all.x = TRUE)

rel.growth = growth.rate(d.economic.activity)

d.comb = d.comb[, economic.activity.estimate := ifelse(is.na(economic.activity), "Naiver Schätzer", "Statistik\nAustria"), ]
d.comb = d.comb[, economic.activity := ifelse(is.na(economic.activity), rel.growth * lag(economic.activity, 365), economic.activity), ]

# d.comb[, `:=`(
#     temp = temp.vienna,
#     hdd = hdd.vienna
# )]


# AUGMENT
# package clock gives weekdays in English, independent of system locale
d.comb[, `:=`(
    t = as.integer(date - min(date)),
    year = year(date),
    day = yday(date),
    week = week(date),
    month = month(date),
    wday = factor(as.character(clock::date_weekday_factor(date)),
        c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
    ),
    temp.15 = ifelse(temp < 15, 15 - temp, 0),
    temp.squared  = temp^2,
    temp.lag = shift(temp, 1)
)]

d.comb[, `:=`(
    t.squared = t^2,
    workday = ifelse(wday %in% c("Sat", "Sun"), wday, "Working day"),
    week = str_pad(week, 2, pad = "0"),
    temp.15.squared = temp.15^2,
    temp.15.lag = shift(temp.15, 1),
    year_character = as.character(year),
    # temp.f = cut(temp, quantile(temp, 0:20/20), all.inside = TRUE),
    temp.f = cut(temp, seq(min(temp), max(temp), length = 10), all.inside = TRUE)
)]



train.years = c(2019:2021)

d.train = d.comb[year %in% train.years]


estimate = function(model, type="non-economic"){
    d.ret = copy(d.comb)

    m.linear = lm(
        model
        , data = d.train)

    #print(summary(m.linear))

    prediction.prediction = predict(m.linear, d.ret, interval = "prediction", level = 0.95) %>%
        as.data.table()

    prediction.confidence = predict(m.linear, d.ret, interval = "confidence", level = 0.95) %>%
        as.data.table()

    d.ret[, `:=`(prediction = prediction.prediction$fit,
                  lower.pred = prediction.prediction$lwr,
                  upper.pred = prediction.prediction$upr,
                  lower.conf = prediction.confidence$lwr,
                  upper.conf = prediction.confidence$upr), ]

    d.ret[, `:=` (difference = (value - prediction) / prediction,
                   diff.pred.lower = (value - lower.pred) / lower.pred,
                   diff.pred.upper = (value - upper.pred) / upper.pred,
                   diff.conf.lower = (value - lower.conf) / lower.conf,
                   diff.conf.upper = (value - upper.conf) / upper.conf,
                   model.type = type
                   ), ]

    return(d.ret)
}

model = value ~
    # value.lag + value.lag2 + # AR TERMS
    temp + temp.squared + temp.15 + temp.15.lag + temp.15.squared +
    # temp * as.factor(temp.f) +
    wday + is.holiday + as.factor(vacation.name) + is.lockdown + is.hard.lockdown

d.pred.non.economic = estimate(model)

d.pred.non.economic %>% 
    filter(year == 2022) %>% 
    dplyr::select(date, value, prediction) %>% 
    gather(Typ, value, -date) %>%  
    mutate(Typ = ifelse(Typ == "prediction", "Simulation", "Beobachtung")) %>% 
    mutate(value = rollmean(value, 14, fill = NA)) %>% 
    ggplot(aes(x = date, y = value)) +
        geom_line(aes(col = Typ), size = 1) +
        scale_color_manual(values = COLORS3) +
        scale_x_date(date_labels = "%b",date_breaks  ="1 month") +
        xlab(NULL) + ylab(NULL) +
        labs(title = "Täglicher Gasverbrauch", subtitle = "in TWh, 14-tägiges Mittel")
```

Besser sieht man das noch, wenn man die Differenz zwischen den beiden als Abweichung plottet, die Einsparung also prozentuell darstellt.Die graue Fläche zeigt dabei die Unsicherheit in unserer Simulation. Hier erscheinen die Einsparungen im November gering. Stimmt das aber so?

```{r figure4}

d.pred.non.economic %>%
    dplyr::select(date, difference, diff.conf.lower, diff.conf.upper) %>%
    filter(year(date) == 2022) %>%
    gather(variable, value, -date) %>%
    filter(variable %in% c("difference", "diff.conf.lower", "diff.conf.upper")) %>%
    group_by(variable) %>%
    mutate(value = rollmean(100 * value, 30, fill = NA, align = "right")) %>%
    ungroup() %>%
    spread(variable, value) %>%
    ggplot(aes(x = date, y = difference)) +
        geom_abline(slope = 0, intercept = 0, size = 0.5, linetype = 2) +
        geom_ribbon(aes(ymin = diff.conf.lower, ymax = diff.conf.upper), alpha=0.3) +
        geom_line(size = 1) +
        xlab(NULL) + ylab(NULL) +
        scale_colour_manual(values=c("red", "black")) +
        scale_fill_manual(values=c("red", "black")) +
        scale_x_date(date_labels = "%b",date_breaks  ="1 month") +
        scale_y_continuous(n.breaks = 10) +
        labs(title = "Veränderung Gasverbrauch (mit Stromproduktion)", subtitle = "Relative Differenz zwischen Schätzung und Observation, in %")
```

Nun, ein beträchtlicher Anteil des österreichischen Gaskonsums geht in die Stromproduktion. Rechnet man diesen Anteil heraus, so ergeben sich sehr viel höhere Einsparungseffekte - die hohen Einsprungen bei Haushalten und Industrie werden also durch im Vergleich relativ hohe Verstromung von Gas in diesem Jahr reduziert. Während die Einsparungen im Oktober also etwas zurückgegangen sind, sind sie noch immer beträchtlich, wenn man den Stromsektor nicht berücksichtigt.

```{r figure5}
estimate = function(model, type="non-economic"){
    d.ret = copy(d.comb)

    m.linear = lm(
        model
        , data = d.train)

    #print(summary(m.linear))

    prediction.prediction = predict(m.linear, d.ret, interval = "prediction", level = 0.95) %>%
        as.data.table()

    prediction.confidence = predict(m.linear, d.ret, interval = "confidence", level = 0.95) %>%
        as.data.table()

    d.ret[, `:=`(prediction = prediction.prediction$fit,
                  lower.pred = prediction.prediction$lwr,
                  upper.pred = prediction.prediction$upr,
                  lower.conf = prediction.confidence$lwr,
                  upper.conf = prediction.confidence$upr), ]

    d.ret[, `:=` (difference = (value.without.power - prediction) / prediction,
                   diff.pred.lower = (value.without.power - lower.pred) / lower.pred,
                   diff.pred.upper = (value.without.power - upper.pred) / upper.pred,
                   diff.conf.lower = (value.without.power - lower.conf) / lower.conf,
                   diff.conf.upper = (value.without.power - upper.conf) / upper.conf,
                   model.type = type
                   ), ]

    return(d.ret)
}

model = value.without.power ~
    # value.lag + value.lag2 + # AR TERMS
    temp + temp.squared + temp.15 + temp.15.lag + temp.15.squared +
    # temp * as.factor(temp.f) +
    wday + is.holiday + as.factor(vacation.name) + is.lockdown + is.hard.lockdown

d.pred.non.economic.no.power = estimate(model)

d.pred.non.economic.no.power %>%
    dplyr::select(date, difference, diff.conf.lower, diff.conf.upper) %>%
    filter(year(date) == 2022) %>%
    gather(variable, value, -date) %>%
    filter(variable %in% c("difference", "diff.conf.lower", "diff.conf.upper")) %>%
    group_by(variable) %>%
    mutate(value = rollmean(100 * value, 30, fill = NA, align = "right")) %>%
    ungroup() %>%
    spread(variable, value) %>%
    ggplot(aes(x = date, y = difference)) +
        geom_abline(slope = 0, intercept = 0, size = 0.5, linetype = 2) +
        geom_ribbon(aes(ymin = diff.conf.lower, ymax = diff.conf.upper), alpha=0.3) +
        geom_line(size = 1) +
        xlab(NULL) + ylab(NULL) +
        scale_colour_manual(values=c("red", "black")) +
        scale_fill_manual(values=c("red", "black")) +
        scale_x_date(date_labels = "%b",date_breaks  ="1 month") +
        scale_y_continuous(n.breaks = 10) + 
        labs(title = "Veränderung Gasverbrauch (ohne Stromproduktion)", subtitle = "Relative Differenz zwischen Schätzung und Observation, in %")
```

```{r savingsFinal}
mean.2019.2021.gas.no.power = d.base %>% 
    filter(year > 2018 & year < 2022) %>% 
    filter(day <= max.day$max.day) %>% 
    group_by(year) %>% 
    summarize(sum.val = sum(value.without.power)) %>% 
    summarize(sum.val.mean = mean(sum.val))

relative.savings.no.power = d.base %>% 
    filter(year > 2018) %>% 
    group_by(year) %>% 
    filter(day <= max.day$max.day) %>% 
    summarize(rel.save = 100 * (sum(value.without.power)-mean.2019.2021.gas.no.power$sum.val.mean)/mean.2019.2021.gas.no.power$sum.val.mean)

relative.savings.predicted = d.pred.non.economic %>% 
    filter(year > 2018) %>% 
    group_by(year) %>% 
    filter(day <= max.day$max.day) %>% 
    summarize(rel.save = 100 * (sum(prediction)-mean.2019.2021.gas$sum.val.mean)/mean.2019.2021.gas$sum.val.mean)

relative.savings.no.power.predicted = d.pred.non.economic.no.power %>% 
    filter(year > 2018) %>% 
    group_by(year) %>% 
    filter(day <= max.day$max.day) %>% 
    summarize(rel.save = 100 * (sum(prediction)-mean.2019.2021.gas.no.power$sum.val.mean)/mean.2019.2021.gas.no.power$sum.val.mean)

savings.2022.no.power = relative.savings.no.power %>% 
    filter(year == 2022) 

savings.2022.predicted = relative.savings.predicted %>% 
    filter(year == 2022) 

savings.2022.no.power.predicted = relative.savings.no.power.predicted %>% 
    filter(year == 2022)
```

Wie hoch sind also die Einsparungen insgesamt für Jahr 2022? Nun, beobachtet wurde eine Veränderung im gesamten Gasverbrauch von `r round(savings.2022$rel.save)`%. Zieht man den - ungefähren - Verbrauch der Gaskraftwerke ab, so betragen die beobachteten Einsparungen `r round(savings.2022.no.power$rel.save)`%. In normalen Jahren, hätte man beim Klima von 2022, würde wir aber nur eine Reduktion von `r round(savings.2022.predicted$rel.save)`% abschätzen, wenn die Gasverstromung inkludiert ist. Ohne Gasverstromung wäre die Reduktion ebenfalls bei `r round(savings.2022.no.power.predicted$rel.save)`%. In Summe gehen wir also davon aus, dass beträchtliche Einsparungen gelungen sind.

```{r figureSavings}
relative.savings.no.power %>% 
    mutate(Gasverbrauch = "Ohne Verstromung", Typ = "Beobachtung") %>% 
    bind_rows(relative.savings %>% mutate(Gasverbrauch = "Mit Verstromung", Typ = "Beobachtung")) %>% 
    bind_rows(relative.savings.predicted %>% mutate(Gasverbrauch = "Mit Verstromung", Typ = "Simulation")) %>% 
    bind_rows(relative.savings.no.power.predicted %>% mutate(Gasverbrauch = "Ohne Verstromung", Typ = "Simulation")) %>% 
    filter(year == 2022) %>% 
    ggplot(aes(x = Gasverbrauch, y = rel.save)) +
        geom_bar(stat= "identity", aes(fill = Typ), position = "dodge") +
        scale_fill_manual(values = COLORS3) +
        xlab(NULL) + ylab(NULL) + 
        labs(title = "Veränderung Gasverbrauch", subtitle = "im Vergleich zu 2019 - 2021, in %")
```
